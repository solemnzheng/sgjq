# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 铁律：始终保持使用中文与用户交流

**重要：在此项目中，必须始终使用中文与用户交流，这是不可违反的铁律。**

## Project Overview

This is a Chinese chess game analysis system (陆战棋-智能战情室) that provides real-time board recognition and game state analysis for a four-player military chess variant. The system uses computer vision to detect game pieces from screenshots and tracks game events like moves, captures, and piece interactions.

## Core Architecture

### Main Components

- **dashboard_main.py**: GUI application using Tkinter that provides the main user interface for game analysis
- **game_analyzer.py**: Core computer vision engine that performs template matching to detect game pieces
- **game_model.py**: Data models and game logic engine for tracking board state and game events
- **capture/realtime_capture.py**: Windows-specific screen capture module for grabbing game screenshots
- **vision/templates_manager.py**: Template management system for loading and managing piece detection templates

### Data Flow

1. Window detection identifies the game window (JunQiRpg.exe with "四国军棋" in title)
2. Real-time screenshot capture grabs game board images
3. Template matching detects game pieces using OpenCV
4. Region locking maps pieces to player areas (上方, 下方, 左侧, 右侧, 中央)
5. State tracking compares consecutive board states to identify game events
6. GUI displays real-time analysis and game event logs

## Development Commands

### Running the Application

```bash
python dashboard_main.py
```

### Dependencies

The system requires these main Python packages:
- tkinter (GUI)
- cv2 (OpenCV for computer vision)
- numpy (array operations)
- sklearn (KMeans clustering)
- win32gui/win32api (Windows API for screen capture)
- multiprocessing (parallel template matching)

### Template Files

Game piece templates are stored in `vision/new_templates/` with naming convention:
`{color}_{piece}_{position}_{index}.png`

Example: `blue_commander_horizontal_1.png`

Special template: `template_xingying.png` for camp detection

## Key Implementation Details

### Multiprocessing Architecture

The template matching uses multiprocessing with a static top-level function `parallel_find_matches_static()` to avoid pickling issues when passing objects between processes.

### Region Detection

The system automatically detects 5 regions:
- 4 player regions (上方, 下方, 左侧, 右侧)
- 中央 (center playing area)

Region coordinates are cached in `data/regions.json` after first detection.

### Game Logic

- Piece ranking system with military hierarchy (司令=10, 军长=9, etc.)
- Alliance relationships: 上方↔下方 vs 左侧↔右侧
- Event detection: moves, captures, trades, bomb explosions, landmine hits

### Error Handling

Known multiprocessing pickling issue is resolved in line 85 of game_analyzer.py by using the static function approach.

## File Structure

```
E:\SGJQ_CC\
├── dashboard_main.py          # Main GUI application
├── game_analyzer.py           # Computer vision engine
├── game_model.py              # Data models and game logic
├── capture/
│   ├── realtime_capture.py    # Windows screen capture
│   └── __init__.py
├── vision/
│   ├── templates_manager.py   # Template management
│   ├── detect.py             # Detection utilities
│   ├── utils.py              # Vision utilities
│   └── __init__.py
├── data/
│   └── regions.json          # Cached region coordinates
└── vision/new_templates/      # Piece detection templates
```

## Development Notes

- The system targets Windows specifically due to win32 API dependencies
- Template matching threshold default is 0.8 but can be adjusted
- The GUI supports both single recognition and continuous monitoring modes
- All piece tracking uses unique IDs generated by color and piece type
- Board coordinates use (row, col) system relative to detected regions